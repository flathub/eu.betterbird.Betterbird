
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1756844260 0
# Node ID 037434bf26d8583cd8ccb5b7b4c29e9313c050a0
# Parent  32a7d6049b5e975df6f1137245499eab3d80d35a
Bug 1986289 - Do not close Filter Rules dialog by Return key after entering search value. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D263475

diff --git a/mail/test/browser/folder-widget/browser_messageFilters.js b/mail/test/browser/folder-widget/browser_messageFilters.js
--- a/mail/test/browser/folder-widget/browser_messageFilters.js
+++ b/mail/test/browser/folder-widget/browser_messageFilters.js
@@ -179,27 +179,41 @@ add_task(async function test_message_fil
 
 /* A helper function that opens up the new filter dialog (assuming that the
  * main filters dialog is already open), creates a simple filter, and then
  * closes the dialog.
  */
 async function create_simple_filter() {
   const filterc = await openFiltersDialogs();
 
-  function fill_in_filter_fields(fec) {
+  async function fill_in_filter_fields(fec) {
     const filterName = fec.document.getElementById("filterName");
     filterName.value = "A Simple Filter";
     fec.document.getElementById("searchAttr0").value = Ci.nsMsgSearchAttrib.To;
     fec.document.getElementById("searchOp0").value = Ci.nsMsgSearchOp.Is;
     const searchVal = fec.document.getElementById("searchVal0").input;
     searchVal.setAttribute("value", "test@foo.invalid");
 
     const filterActions = fec.document.getElementById("filterActionList");
     const firstAction = filterActions.getItemAtIndex(0);
     firstAction.setAttribute("value", "markasflagged");
+
+    // Test that pressing Enter adds another search row and does not close
+    // the dialog. Remove the second row afterwards.
+    EventUtils.synthesizeMouseAtCenter(searchVal, {}, fec);
+    EventUtils.synthesizeKey("KEY_Enter", {}, fec);
+    await new Promise(resolve => requestIdleCallback(resolve));
+    EventUtils.synthesizeMouseAtCenter(
+      fec.document
+        .getElementById("searchRow1")
+        .getElementsByClassName("small-button")[1],
+      {},
+      fec
+    );
+
     fec.document.querySelector("dialog").acceptDialog();
   }
 
   // Let's open the filter editor.
   const dialogPromise = promise_modal_dialog(
     "mailnews:filtereditor",
     fill_in_filter_fields
   );
diff --git a/mailnews/search/content/FilterEditor.js b/mailnews/search/content/FilterEditor.js
--- a/mailnews/search/content/FilterEditor.js
+++ b/mailnews/search/content/FilterEditor.js
@@ -204,16 +204,17 @@ function filterEditorOnLoad() {
 
 function onEnterInSearchTerm(event) {
   if (event.ctrlKey || (Services.appinfo.OS == "Darwin" && event.metaKey)) {
     // If accel key (Ctrl on Win/Linux, Cmd on Mac) was held too, accept the dialog.
     document.querySelector("dialog").acceptDialog();
   } else {
     // If only plain Enter was pressed, add a new rule line.
     onMore(event);
+    event.preventDefault();
   }
 }
 
 function onAccept(event) {
   try {
     if (!saveFilter()) {
       event.preventDefault();
       return;

