
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1753811091 14400
# Node ID b86ec7eb9e5d946a0f60f752c221a82213fd1785
# Parent  c0c0b35f7fc01c4b1fbeed1366eb8994662c30db
Bug 1979567 - Make sure contacts panel item is selected when dragging. r=darktrojan

Differential Revision: https://phabricator.services.mozilla.com/D258828

diff --git a/mail/components/addrbook/content/abContactsPanel.js b/mail/components/addrbook/content/abContactsPanel.js
--- a/mail/components/addrbook/content/abContactsPanel.js
+++ b/mail/components/addrbook/content/abContactsPanel.js
@@ -228,19 +228,23 @@ function AbPanelLoad() {
   );
   gAbResultsTree.table.body.addEventListener("click", event =>
     contactsListOnClick(event)
   );
   gAbResultsTree.addEventListener("select", () => {
     gAbResultsTree.view.selectionChanged();
     document.commandDispatcher.updateCommands("addrbook-select");
   });
-  gAbResultsTree.table.addEventListener("dragstart", event =>
-    abResultsPaneObserver.onDragStart(event)
-  );
+  gAbResultsTree.table.addEventListener("dragstart", event => {
+    const row = event.target.closest(`tr[is="auto-tree-view-table-row"]`);
+    if (!gAbResultsTree.selectedIndices.includes(row.index)) {
+      gAbResultsTree.selectedIndex = row.index;
+    }
+    abResultsPaneObserver.onDragStart(event);
+  });
   gAbResultsTree.addEventListener("columns-changed", event => {
     if (event.detail.value == "addrbook") {
       abColumnHidden = !event.detail.target.hasAttribute("checked");
       Services.xulStore.setValue(
         xulStoreURL,
         "abResultsTree",
         "abColumnHidden",
         abColumnHidden
diff --git a/mail/components/addrbook/test/browser/browser_contact_sidebar.js b/mail/components/addrbook/test/browser/browser_contact_sidebar.js
--- a/mail/components/addrbook/test/browser/browser_contact_sidebar.js
+++ b/mail/components/addrbook/test/browser/browser_contact_sidebar.js
@@ -488,39 +488,54 @@ add_task(async function testSidebar() {
     "pèóplë named tēst <pèóplë named tēst>",
   ]);
 
   clearPills();
 
   if (dragService) {
     // Check that drag and drop to the recipients section works.
 
-    clickOnRow(5, {});
+    const dragAndDropRow = (row, target) => {
+      dragService.startDragSessionForTests(
+        sidebarWindow,
+        Ci.nsIDragService.DRAGDROP_ACTION_NONE
+      );
+      const [result, dataTransfer] = EventUtils.synthesizeDragOver(
+        cardsList.getRowAtIndex(row),
+        target,
+        null,
+        null,
+        sidebarWindow,
+        composeWindow
+      );
+      EventUtils.synthesizeDropAfterDragOver(
+        result,
+        dataTransfer,
+        target,
+        composeWindow
+      );
 
-    dragService.startDragSessionForTests(
-      sidebarWindow,
-      Ci.nsIDragService.DRAGDROP_ACTION_NONE
+      dragService.getCurrentSession().endDragSession(true);
+    };
+
+    clickOnRow(5, {});
+    dragAndDropRow(5, toAddrInput);
+    checkPills(toAddrRow, ["năthån test <năthån.test@invalid>"]);
+
+    // Test that dragging an unselected row also works correctly.
+    dragAndDropRow(3, toAddrInput);
+    checkPills(toAddrRow, [
+      "năthån test <năthån.test@invalid>",
+      "katherine test <katherine.test@invalid>",
+    ]);
+    Assert.equal(
+      cardsList.selectedIndex,
+      3,
+      "Dragging a contact should select it as well."
     );
-    const [result, dataTransfer] = EventUtils.synthesizeDragOver(
-      cardsList.getRowAtIndex(5),
-      toAddrInput,
-      null,
-      null,
-      sidebarWindow,
-      composeWindow
-    );
-    EventUtils.synthesizeDropAfterDragOver(
-      result,
-      dataTransfer,
-      toAddrInput,
-      composeWindow
-    );
-
-    dragService.getCurrentSession().endDragSession(true);
-    checkPills(toAddrRow, ["năthån test <năthån.test@invalid>"]);
 
     clearPills();
   }
 
   // Check that the "Add to" buttons work.
 
   clickOnRow(7, {});
 

