
# HG changeset patch
# User Ben Bucksch <ben.bucksch@beonex.com>
# Date 1750157543 -10800
# Node ID 44891cb1939019b5f95d232fe45d0cf4ec28e0aa
# Parent  ea78f3bf22a72b6d91a3e550970a14d52e9efa3b
Bug 1951824 - Exchange AutoDiscover: Fix code to show username field. r=Neil,babolivier,vineet

Differential Revision: https://phabricator.services.mozilla.com/D240404

diff --git a/mail/components/accountcreation/content/accountSetup.js b/mail/components/accountcreation/content/accountSetup.js
--- a/mail/components/accountcreation/content/accountSetup.js
+++ b/mail/components/accountcreation/content/accountSetup.js
@@ -334,28 +334,30 @@ var gAccountSetup = {
           document.getElementById("accountSetupDescription"),
           "account-setup-description"
         );
 
         document.getElementById("resultsArea").hidden = true;
         document.getElementById("manualConfigArea").hidden = true;
         document.getElementById("manualConfigButton").hidden = true;
         document.getElementById("stopButton").hidden = true;
+        document.getElementById("usernameRow").hidden = true;
 
         reTestButton.hidden = true;
         autoconfigDesc.hidden = true;
         createButton.hidden = true;
         continueButton.disabled = true;
         continueButton.hidden = false;
         break;
       case "find-config":
         document.getElementById("resultsArea").hidden = true;
         document.getElementById("manualConfigArea").hidden = true;
         document.getElementById("manualConfigButton").hidden = true;
         document.getElementById("stopButton").hidden = false;
+        document.getElementById("usernameRow").hidden = true;
 
         reTestButton.hidden = true;
         autoconfigDesc.hidden = true;
         createButton.hidden = true;
         continueButton.disabled = true;
         continueButton.hidden = false;
         this.onStop = this.onStopFindConfig;
         break;
@@ -676,16 +678,20 @@ var gAccountSetup = {
             config.incomingAlternatives.push(exchangeIncoming);
           }
         }
       } else {
         // None of the priority-ordered mechanisms produced a config. If
         // Autodiscover also produced nothing, we make a best effort to guess a
         // valid configuration.
         if (!autodiscoverCall.succeeded) {
+          if (autodiscoverCall.e instanceof ExchangeUsernameException) {
+            this._showExchangeUsername();
+            return;
+          }
           const initialConfig = new AccountConfig();
           this._prefillConfig(initialConfig);
           // `_guessConfig()` will call `foundConfig()` for us if it succeeds.
           this._guessConfig(domain, initialConfig);
           return;
         }
 
         config = autodiscoverCall.result;
@@ -768,28 +774,17 @@ var gAccountSetup = {
         autodiscoverCall.successCallback(),
         (e, allErrors) => {
           // Must call error callback in any case to stop the discover mode.
           const errorCallback = autodiscoverCall.errorCallback();
           if (e instanceof CancelledException) {
             errorCallback(e);
           } else if (allErrors && allErrors.some(err => err.code == 401)) {
             // Auth failed.
-            // Ask user for username.
-            this.onStartOver();
-            this.stopLoadingState(); // clears status message
-            document.getElementById("usernameRow").hidden = false;
-
-            this.showErrorNotification(
-              !this._exchangeUsername
-                ? "account-setup-credentials-incomplete"
-                : "account-setup-credentials-wrong"
-            );
-            document.getElementById("manualConfigButton").hidden = false;
-            errorCallback(new CancelledException());
+            errorCallback(new ExchangeUsernameException());
           } else {
             errorCallback(e);
           }
         }
       );
       autodiscoverCall.setAbortable(autodiscoverTask);
     } catch (e) {
       this.onStop();
@@ -827,16 +822,29 @@ var gAccountSetup = {
         return "account-setup-success-guess";
       }
       default: {
         throw new Error(`Unexpected source: ${config.source}`);
       }
     }
   },
 
+  _showExchangeUsername() {
+    this.onStartOver();
+    this.stopLoadingState(); // clears status message
+    document.getElementById("usernameRow").hidden = false;
+
+    this.showErrorNotification(
+      !this._exchangeUsername
+        ? "account-setup-credentials-incomplete"
+        : "account-setup-credentials-wrong"
+    );
+    document.getElementById("manualConfigButton").hidden = false;
+  },
+
   /**
    * Just a continuation of findConfig()
    */
   _guessConfig(domain, initialConfig) {
     this.startLoadingState("account-setup-looking-up-settings-guess");
     const self = this;
     self._abortable = GuessConfig.guessConfig(
       domain,
@@ -2938,16 +2946,18 @@ function serverMatches(a, b) {
     a.type == b.type &&
     a.hostname == b.hostname &&
     a.port == b.port &&
     a.socketType == b.socketType &&
     a.auth == b.auth
   );
 }
 
+class ExchangeUsernameException extends Exception {}
+
 /**
  * Warning dialog, warning user about lack of, or inappropriate, encryption.
  */
 var gSecurityWarningDialog = {
   /**
    * {Array of {(incoming or outgoing) server part of {AccountConfig}}
    * A list of the servers for which we already showed this dialog and the
    * user approved the configs. For those, we won't show the warning again.

