
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1762275100 0
# Node ID 28c7d645a1973fbcda42b184495dfd5436b21e0c
# Parent  6eeb9a620a367763051fec2d7b8d962a79d23887
Bug 1991417 - Prevent extension errors on cmd_newMessage with empty folder pane. r=john.bieling

Differential Revision: https://phabricator.services.mozilla.com/D270140

diff --git a/mail/components/extensions/parent/ext-mailTabs.js b/mail/components/extensions/parent/ext-mailTabs.js
--- a/mail/components/extensions/parent/ext-mailTabs.js
+++ b/mail/components/extensions/parent/ext-mailTabs.js
@@ -59,20 +59,26 @@ function convertMailTab(tab, context) {
 
   // The API uses "unified" instead of "smart".
   const fixApiModeName = name => (name == "smart" ? "unified" : name);
 
   const mailTabObject = {
     windowId: tab.windowId,
     active: tab.active,
     layout: LAYOUTS[gDynamicPaneConfig],
-    folderMode: fixApiModeName(about3Pane.folderTree.selectedRow.modeName),
     folderModesEnabled: about3Pane.folderPane.activeModes.map(fixApiModeName),
   };
 
+  const folderMode = fixApiModeName(
+    about3Pane.folderTree.selectedRow?.modeName
+  );
+  if (folderMode) {
+    mailTabObject.folderMode = folderMode;
+  }
+
   if (context.extension.manifest.manifest_version < 3) {
     mailTabObject.id = tab.id;
   } else {
     mailTabObject.tabId = tab.id;
   }
 
   mailTabObject.folderPaneVisible = paneLayout.folderPaneVisible;
   mailTabObject.messagePaneVisible = paneLayout.messagePaneVisible;
@@ -316,17 +322,17 @@ this.mailTabs = class extends ExtensionA
         folderMode,
       } = properties;
 
       let folder;
       if (displayedFolderId || displayedFolder) {
         folder = getFolder(displayedFolderId || displayedFolder).folder;
       }
 
-      const curFolderMode = about3Pane.folderTree.selectedRow.modeName;
+      const curFolderMode = about3Pane.folderTree.selectedRow?.modeName;
       const curFolderModes = about3Pane.folderPane.activeModes;
       const newFolderMode = folderMode ? fixTbModeName(folderMode) : null;
       let newFolderModes = folderModesEnabled
         ? folderModesEnabled.map(fixTbModeName)
         : null;
 
       // Switching to a folder pane mode should always enable it, if needed.
       if (
@@ -657,17 +663,17 @@ this.mailTabs = class extends ExtensionA
             }
 
             // Only enforce folder switch, if the messages are not already in the
             // current view.
             if (allInCurrentView) {
               selectedIndices = foundIndices;
             } else {
               // Stay within the current folderMode, if possible.
-              const curFolderMode = about3Pane.folderTree.selectedRow.modeName;
+              const curFolderMode = about3Pane.folderTree.selectedRow?.modeName;
               let row = about3Pane.folderPane.getRowForFolder(
                 msgHdrs[0].folder,
                 curFolderMode
               );
               // Fallback to any other of the enabled folder modes.
               if (!row) {
                 row = about3Pane.folderPane.getRowForFolder(msgHdrs[0].folder);
               }

