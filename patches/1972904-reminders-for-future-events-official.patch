
# HG changeset patch
# User Magnus Melin <mkmelin+mozilla@iki.fi>
# Date 1757984818 21600
# Node ID d540e9e7da974f2d113a53790719018e6255c4f3
# Parent  2045d8dc76141000ccc5c8985065d91bebe99ac0
Bug 1972904 - For show missed reminders, account for missing end dates and moved due dates. r=tobyp


Inspired by https://github.com/Betterbird/thunderbird-patches/blob/main/140/bugs/1988288-reminders-for-future-events.patch

Differential Revision: https://phabricator.services.mozilla.com/D264784

diff --git a/calendar/base/src/CalAlarmService.sys.mjs b/calendar/base/src/CalAlarmService.sys.mjs
--- a/calendar/base/src/CalAlarmService.sys.mjs
+++ b/calendar/base/src/CalAlarmService.sys.mjs
@@ -480,32 +480,38 @@ CalAlarmService.prototype = {
         // could snooze or dismiss alarms. See if it has been previously
         // ack'd.
         const lastAck = aItem.parentItem.alarmLastAck;
         if (lastAck && lastAck.compare(alarmDate) >= 0) {
           // The alarm was previously dismissed or snoozed, no further
           // action required.
           continue;
         }
-
-        let ongoingEvent = false;
-        const tz = alarmDate.timezone.isFloating ? cal.dtz.floating : cal.dtz.UTC;
-        const itemStart = aItem[cal.dtz.startDateProp(aItem)].getInTimezone(tz);
-        const itemEnd = aItem[cal.dtz.endDateProp(aItem)].getInTimezone(tz);
-        if (itemStart && itemEnd) {
-          // Ensure isDate false so we get hour/minute/second for all-day events.
-          itemStart.isDate = false;
-          itemEnd.isDate = false;
-          ongoingEvent = now.compare(itemStart) >= 0 && now.compare(itemEnd) <= 0;
+        if (showMissed) {
+          // The alarm was not snoozed or dismissed, fire it now.
+          this.alarmFired(aItem, alarm);
+          continue;
         }
 
-        if (showMissed || ongoingEvent) {
-          // The alarm was not snoozed or dismissed, fire it now.
-          // Or if the event is ongoing but we haven't fired. Especially important
-          // for all-day events where alarm would have set off at midnight.
+        const tz = alarmDate.timezone.isFloating ? cal.dtz.floating : cal.dtz.UTC;
+        const itemStart = aItem[cal.dtz.startDateProp(aItem)]?.getInTimezone(tz);
+        const itemEnd = aItem[cal.dtz.endDateProp(aItem)]?.getInTimezone(tz);
+        // Ensure isDate false so we get hour/minute/second for all-day events.
+        if (itemStart) {
+          itemStart.isDate = false;
+        }
+        if (itemEnd) {
+          itemEnd.isDate = false;
+        }
+
+        // If the event ends in the future / task is due in the future OR
+        // start date is in (was moved to?) the future, show reminder.
+        // Especially important for all-day events where alarm would have set
+        // off at midnight.
+        if (itemEnd?.compare(now) >= 0 || itemStart?.compare(now) >= 0) {
           this.alarmFired(aItem, alarm);
         }
       }
     }
 
     this.addNotificationForItem(aItem);
   },
 

