
# HG changeset patch
# User Magnus Melin <mkmelin+mozilla@iki.fi>
# Date 1758042384 21600
# Node ID da334651f4ea48ef765665f5d52d6ba16227e4cc
# Parent  854c22123f334adc5b0cbfb5c30113616a64fff9
Bug 1981322 - sender avatar should not use only quote as abbreviation. r=tobyp

Differential Revision: https://phabricator.services.mozilla.com/D264757

diff --git a/mail/base/content/widgets/header-fields.js b/mail/base/content/widgets/header-fields.js
--- a/mail/base/content/widgets/header-fields.js
+++ b/mail/base/content/widgets/header-fields.js
@@ -557,19 +557,22 @@
         this.avatar.classList.add("has-avatar");
       } else {
         this._createAvatarPlaceholder();
       }
     }
 
     _createAvatarPlaceholder() {
       const letter = document.createElement("span");
-      letter.textContent = Array.from(
-        this.nameLine.textContent || this.displayName || this.fullAddress
-      )[0]?.toUpperCase();
+      letter.textContent =
+        Array.from(
+          (this.nameLine.textContent || this.displayName || this.fullAddress)
+            ?.normalize()
+            .replaceAll(/[^\p{Letter}\p{Nd}]+/gu, "")
+        )[0]?.toUpperCase() || "";
       letter.setAttribute("aria-hidden", "true");
       this.avatar.appendChild(letter);
       this.avatar.classList.remove("has-avatar");
     }
 
     addToAddressBook() {
       const card = Cc["@mozilla.org/addressbook/cardproperty;1"].createInstance(
         Ci.nsIAbCard
diff --git a/mail/components/addrbook/content/aboutAddressBook.js b/mail/components/addrbook/content/aboutAddressBook.js
--- a/mail/components/addrbook/content/aboutAddressBook.js
+++ b/mail/components/addrbook/content/aboutAddressBook.js
@@ -442,16 +442,28 @@ function updateSharedSplitter(isTableLay
     isTableLayout ? "detailsPane" : "cardsPane"
   );
 
   splitter.isCollapsed =
     document.getElementById("detailsPane").hidden && isTableLayout;
 }
 
 /**
+ * @param {?string} displayName - The name.
+ * @returns {string} what to display as avatar for the name.
+ */
+function avatarPlaceholder(displayName) {
+  return (
+    Array.from(
+      displayName?.normalize().replaceAll(/[^\p{Letter}\p{Nd}]+/gu, "")
+    )[0]?.toUpperCase() || ""
+  );
+}
+
+/**
  * Update all commands that are affected by the contents of the address book
  * tab.
  */
 function updateAbCommands() {
   const { topChromeWindow } = window.browsingContext;
   topChromeWindow.goUpdateCommand("cmd_createAddressBook");
   topChromeWindow.goUpdateCommand("cmd_createAddressBookCARDDAV");
   topChromeWindow.goUpdateCommand("cmd_createAddressBookLDAP");
@@ -1288,19 +1300,17 @@ customElements.whenDefined("tree-view-ta
         const photoURL = card.photoURL;
         if (photoURL) {
           const img = document.createElement("img");
           img.alt = this.name.textContent;
           img.src = photoURL;
           this.avatar.replaceChildren(img);
         } else {
           const letter = document.createElement("span");
-          letter.textContent = Array.from(
-            this.name.textContent
-          )[0]?.toUpperCase();
+          letter.textContent = avatarPlaceholder(this.name.textContent);
           letter.setAttribute("aria-hidden", "true");
           this.avatar.replaceChildren(letter);
         }
         this.address.textContent = card.primaryEmail;
       } else {
         this.classList.add("MailList");
         const img = document.createElement("img");
         img.alt = "";
@@ -2971,17 +2981,17 @@ var detailsPane = {
         const photoURL = card.photoURL;
         if (photoURL) {
           const img = document.createElement("img");
           img.alt = name.textContent;
           img.src = photoURL;
           avatar.appendChild(img);
         } else {
           const letter = document.createElement("span");
-          letter.textContent = Array.from(name.textContent)[0]?.toUpperCase();
+          letter.textContent = avatarPlaceholder(name.textContent);
           letter.setAttribute("aria-hidden", "true");
           avatar.appendChild(letter);
         }
       } else {
         name.textContent = card.displayName;
 
         const img = avatar.appendChild(document.createElement("img"));
         img.alt = "";
@@ -3779,17 +3789,17 @@ var detailsPane = {
       const photoURL = card.photoURL;
       if (photoURL) {
         const img = document.createElement("img");
         img.alt = name.textContent;
         img.src = photoURL;
         avatar.appendChild(img);
       } else {
         const letter = document.createElement("span");
-        letter.textContent = Array.from(name.textContent)[0]?.toUpperCase();
+        letter.textContent = avatarPlaceholder(name.textContent);
         letter.setAttribute("aria-hidden", "true");
         avatar.appendChild(letter);
       }
     }
     this.selectedCardsSection.hidden = list.childElementCount == 0;
 
     const book = MailServices.ab.getDirectoryFromUID(listCard.directoryUID);
     this.writeButton.hidden = list.childElementCount == 0;

