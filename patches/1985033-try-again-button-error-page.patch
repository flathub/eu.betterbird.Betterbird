
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1756314693 14400
# Node ID c12ca715def69fbab90f10e4037fc2176fa9582c
# Parent  2c1f49de6b6663526f9f90ccece1ee135cf046ea
Bug 1985033 - Have 'Try Again' button on about:neterror page reload the message. r=darktrojan

Differential Revision: https://phabricator.services.mozilla.com/D262376

diff --git a/mail/base/content/aboutMessage.js b/mail/base/content/aboutMessage.js
--- a/mail/base/content/aboutMessage.js
+++ b/mail/base/content/aboutMessage.js
@@ -141,16 +141,17 @@ window.addEventListener("DOMContentLoade
 
   MailServices.mailSession.AddFolderListener(
     folderListener,
     Ci.nsIFolderListener.removed
   );
 
   preferenceObserver.init();
   Services.obs.addObserver(msgObserver, "message-content-updated");
+  Services.obs.addObserver(msgObserver, "ipc:network:set-offline");
 
   const browser = getMessagePaneBrowser();
 
   if (parent == top) {
     // Standalone message display? Focus the message pane.
     browser.focus();
   }
 
@@ -220,16 +221,17 @@ window.addEventListener("DOMContentLoade
 });
 
 window.addEventListener("unload", () => {
   ClearPendingReadTimer();
   OnUnloadMsgHeaderPane();
   MailServices.mailSession.RemoveFolderListener(folderListener);
   preferenceObserver.cleanUp();
   Services.obs.removeObserver(msgObserver, "message-content-updated");
+  Services.obs.removeObserver(msgObserver, "ipc:network:set-offline");
   window.removeEventListener("MsgLoaded", msgObserver);
   prefersDarkQuery.removeEventListener("change", msgObserver);
   gViewWrapper?.close();
 });
 
 /**
  * Display a message.
  *
@@ -440,16 +442,30 @@ var msgObserver = {
     if (
       topic == "message-content-updated" &&
       gMessageURI == subject.QueryInterface(Ci.nsISupportsString).data
     ) {
       // This notification is triggered after a partial pop3 message was
       // fully downloaded. The old message URI is now gone. To reload the
       // message, we display it with its new URI.
       displayMessage(data, gViewWrapper);
+      return;
+    }
+
+    // Check if the 'Try again' button in 'about:neterror' (displayed for NNTP
+    // connection issues) has been pressed. Since this button only enables
+    // online mode, we act on observing the corresponding notification when not
+    // offline.
+    if (
+      topic == "ipc:network:set-offline" &&
+      data == "false" &&
+      gMessageURI?.startsWith("news-message://") &&
+      !Services.io.offline
+    ) {
+      ReloadMessage();
     }
   },
 
   handleEvent(event) {
     switch (event.type) {
       case "MsgLoaded":
         if (prefersDarkQuery.matches) {
           adaptMessageForDarkMode(getMessagePaneBrowser());

