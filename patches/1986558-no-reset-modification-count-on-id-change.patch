
# HG changeset patch
# User welpy-cw <h.w.forms@arcor.de>
# Date 1757051914 -10800
# Node ID d97aeea3694647521b75f99bd82b1577820f1a76
# Parent  e79f24482f961bb032a32c2b8113a8c6f16e5455
Bug 1986558 - Do not reset modification count when manually changing identity. r=mkmelin

Differential Revision: https://phabricator.services.mozilla.com/D263572

diff --git a/mail/components/compose/content/MsgComposeCommands.js b/mail/components/compose/content/MsgComposeCommands.js
--- a/mail/components/compose/content/MsgComposeCommands.js
+++ b/mail/components/compose/content/MsgComposeCommands.js
@@ -639,22 +639,28 @@ var stateListener = {
             ")\n"
         );
     }
 
     // Setting the selected item in the identity list will cause an
     // identity/signature switch. This can only be done once the message
     // body has already been assembled with the signature we need to switch.
     if (gMsgCompose.identity != gCurrentIdentity) {
+      const editor = GetCurrentEditor();
+      editor.enableUndo(false);
+
       const identityList = document.getElementById("msgIdentity");
       identityList.selectedItem = identityList.getElementsByAttribute(
         "identitykey",
         gMsgCompose.identity.key
       )[0];
       LoadIdentity(false);
+
+      editor.enableUndo(true);
+      editor.resetModificationCount();
     }
     if (gMsgCompose.composeHTML) {
       loadHTMLMsgPrefs();
     }
     AdjustFocus();
   },
 
   NotifyComposeBodyReadyNew() {
@@ -9568,18 +9574,16 @@ function LoadIdentity(startup) {
   // Since switching the signature loses the caret position, we record it
   // and restore it later.
   const editor = GetCurrentEditor();
   const selection = editor.selection;
   const range = selection.getRangeAt(0);
   const start = range.startOffset;
   const startNode = range.startContainer;
 
-  editor.enableUndo(false);
-
   // Handle non-startup changing of identity.
   if (prevIdentity && idKey != prevIdentity.key) {
     let changedRecipients = false;
     const prevReplyTo = prevIdentity.replyTo;
     let prevCc = "";
     let prevBcc = "";
     const prevReceipt = prevIdentity.requestReturnReceipt;
     const prevDSN = prevIdentity.DSN;
@@ -9757,18 +9761,17 @@ function LoadIdentity(startup) {
   if (identityElement.editable) {
     identityElement.value = identityElement.selectedItem.value;
     identityElement.placeholder = getComposeBundle().getFormattedString(
       "msgIdentityPlaceholder",
       [identityElement.selectedItem.value]
     );
   }
 
-  editor.enableUndo(true);
-  editor.resetModificationCount();
+  // Restore the caret position following a potential signature switch.
   selection.collapse(startNode, start);
 
   // Try to focus the first available address row. If there are none, focus the
   // Subject which is always available.
   for (const row of document.querySelectorAll(".address-row")) {
     if (focusAddressRowInput(row)) {
       return;
     }
diff --git a/mail/test/browser/message-header/browser_replyIdentity.js b/mail/test/browser/message-header/browser_replyIdentity.js
--- a/mail/test/browser/message-header/browser_replyIdentity.js
+++ b/mail/test/browser/message-header/browser_replyIdentity.js
@@ -158,17 +158,17 @@ add_task(async function test_reply_match
 
   const msg = await select_click_row(-2);
   await assert_selected_and_displayed(window, msg);
 
   const replyWin = await open_compose_with_reply();
   // Should have selected the second id, which is listed in Delivered-To:.
   checkReply(replyWin, identity2Email);
   await close_compose_window(replyWin);
-}).skip();
+});
 
 add_task(async function test_reply_matching_subaddress() {
   await be_in_folder(testFolder);
 
   const msg = await select_click_row(-3);
   await assert_selected_and_displayed(window, msg);
 
   const replyWin = await open_compose_with_reply();

