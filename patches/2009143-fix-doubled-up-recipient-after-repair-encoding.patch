
# HG changeset patch
# User Magnus Melin <mkmelin+mozilla@iki.fi>
# Date 1768347184 18000
# Node ID 26966e8f0a2fb015cde95e2a434c33568e1c1685
# Parent  35585e46996ab42641704e570ee86afa1c4e53d6
Bug 2009143 - Fix "Repair text encoding" not to duplicate recipient and attachments in the UI. r=darktrojan

Differential Revision: https://phabricator.services.mozilla.com/D278631

diff --git a/mail/base/content/aboutMessage.js b/mail/base/content/aboutMessage.js
--- a/mail/base/content/aboutMessage.js
+++ b/mail/base/content/aboutMessage.js
@@ -107,16 +107,17 @@ async function messagePaneOnResize() {
 function ReloadMessage() {
   if (!gMessageURI) {
     return;
   }
   displayMessage(gMessageURI, gViewWrapper);
 }
 
 function MailSetCharacterSet() {
+  ClearCurrentHeaders();
   const messageService = MailServices.messageServiceFromURI(gMessageURI);
   gMessage = messageService.messageURIToMsgHdr(gMessageURI);
   messageService.loadMessage(
     gMessageURI,
     getMessagePaneBrowser().docShell,
     top.msgWindow,
     null,
     true
diff --git a/mail/test/browser/message-reader/browser_detectCharset.js b/mail/test/browser/message-reader/browser_detectCharset.js
--- a/mail/test/browser/message-reader/browser_detectCharset.js
+++ b/mail/test/browser/message-reader/browser_detectCharset.js
@@ -66,16 +66,23 @@ async function extract_eml_body_textcont
     await hiddenPromise;
     await reloadPromise;
   }
 
   const textContent =
     aboutMessage.getMessagePaneBrowser().contentDocument.documentElement
       .textContent;
   const charset = aboutMessage.currentCharacterSet;
+  Assert.equal(
+    aboutMessage.document.querySelector("#expandedtoBox > ol")
+      .childElementCount,
+    1,
+    "should have one To"
+  );
+
   await BrowserTestUtils.closeWindow(msgc);
   return { textContent, charset };
 }
 
 /**
  * Checks that the text content is equal for the .eml files and that
  * the expected charset was detected.
  */

